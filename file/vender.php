<style>    .vender_ladn:hover {        background: #e3e7ea;    }</style><?if ($_POST['send_check']) {    if ($_FILES['upload_file']['size'] < 1024 * 200) {        if (!$_FILES['upload_file']['error']) {            if ((($_FILES["upload_file"]["type"] == "image/gif")                || ($_FILES["upload_file"]["type"] == "image/jpeg")                || ($_FILES["upload_file"]["type"] == "image/png")                || ($_FILES["upload_file"]["type"] == "image/pjpeg"))            ) {                if (is_uploaded_file($_FILES['upload_file']['tmp_name'])) {                    $path = '/upload/';                    $nameFile = $_FILES['upload_file']['name'];                    preg_match('/(.+)?\.(.+)?$/', $nameFile, $output);                    // -- Получаем его MIME-тип --                    $mime = $output[2];                    // -- Изменяем его имя --                    $file = md5(date("Y-m-d H:i:s"));                    $file = $file . '.' . $mime;                    $name = iconv("utf-8", "cp1251", $file);                    // -- Сохраняем полученные файлы с измененными именами в порядке возрастания --                    move_uploaded_file($_FILES['upload_file']['tmp_name'], $path . $name);                }            }        }    }    $date = $_POST['date_y'] . '-' . $_POST['date_m'] . '-' . $_POST['date_d'];    $sql = "INSERT INTO notice VALUES('" . $_SESSION['id_user'] . "','" . $date . "','" . $_POST['checknumber'] . "','" . $_GET['notify'] . "','" . $_FILES['upload_file']['name'] . "','" . $_POST['count'] . "','1')";    $res = mysql_query($sql, $db) or die('нет связи с БД');    $_SESSION['changed'] = 2;    echo '<script language="javascript">	top.location.href="/page/' . CHANGED_PAGE . '";	</script>';} elseif (isset($_GET['notify']) && is_numeric($_GET['notify'])) {    if ($_SESSION['id_user']) {        ?>    <div class="vender_main">Уведомить</div>    <div class="notify_box">        <div class="notify_left">            <script type="text/javascript">                function validate_form() {                    if (document.contact_form.checknumber.value == "") {                        alert("Пожалуйста заполните поле 'Номер чека'.");                        return false;                    }                    if (document.contact_form.count.value == "") {                        alert("Пожалуйста заполните поле 'Сумма покупки'.");                        return false;                    }                    return true;                }            </script>            <form enctype="multipart/form-data" method="post" onsubmit="return validate_form();" name="contact_form">                <table cellpadding="0" cellspacing="9" border="0">                    <tr>                        <td>Номер чека</td>                        <td><input type="text" name="checknumber" class="notify_input" maxlength="30"/></td>                    </tr>                    <tr>                        <td>Дата покупки</td>                        <td><select name="date_d">                            <option selected="selected">День</option>                            <? for ($i = 1; $i <= 31; $i++) {                            echo '<option value=' . $i . '>' . $i . '</option>';                        }?></select>                            <select name="date_m">                                <option selected="selected">Месяц</option><? for ($i = 1; $i <= 12; $i++) {                                echo '<option value=' . $i . '>' . $month[$i] . '</option>';                            }?></select>                            <select name="date_y">                                <option selected="selected">Год                                </option><? for ($i = date("Y") - 1; $i <= date("Y"); $i++) {                                echo '<option value=' . $i . '>' . $i . '</option>';                            }?></select></td>                    </tr>                    <tr>                        <td>Сумма покупки</td>                        <td><input type="text" name="count" class="notify_input" maxlength="30"/></td>                    </tr>                    <tr>                        <td>Фото чека <br/><span>не должно превышать 200кб</span></td>                        <td><input type="file" name="upload_file"/></td>                    </tr>                    <tr>                        <td colspan="2" align="center" style="padding-top:15px;"><input type="submit" name="send_check"                                                                                        value="Отправить"                                                                                        class="notify_btn"/></td>                    </tr>                </table>            </form>        </div>        <div class="notify_right"></div>    </div>    <div style="margin-top:50px;"></div>    <?    } else {        $_SESSION['changed'] = 1;        echo '<script language="javascript">	top.location.href="/page/' . CHANGED_PAGE . '";	</script>';    }} elseif (isset($_GET['partner']) && is_numeric($_GET['partner']))	{    //$sql = "SELECT id, name, adress, phones, url, description, logo, discount FROM vender WHERE id='" . $_GET['partner'] . "' AND active='1' AND city='".$_SESSION['city']."'";    /* Todo: делаем костыль. Id уникальна, можно получать без Session['city']  */    $sql = "SELECT id, name, adress, phones, url, description, logo, discount FROM vender WHERE id='" . $_GET['partner'] . "' AND active='1'";    $res = mysql_query($sql, $db) or die('нет связи с БД');    if ($row = mysql_fetch_row($res)) {        ?>    <div class="vender_name"><? echo stripslashes($row[1]);?></div>    <div class="vender_ldn">        <div class="vender_logo"><img src="<? echo DIR_LOGO_PARTNER . '/' . $row[6]; ?>" width="350" height="60"></div>        <div class="vender_discount">            <div class="vender_discount_header">Скидка:</div>            <div class="vender_discount_yellow"><? echo $row[7];?></div>            <div class="vender_discount_procent"></div>            <div style="clear:left"></div>        </div>        <div class="vender_notify"><?            if (isset($_SESSION['id_user']) && is_numeric($_SESSION['id_user'])) echo '<a href="' . $_SERVER['REQUEST_URI'] . '/notify/' . $row[0] . '" border="0"><img src="' . DIR_MAIN_IMAGES . '/notify_user.png" border="0"/></a>';            else echo '<img src="' . DIR_MAIN_IMAGES . '/notify.png" border="0"/>'; ?>        </div>        <div style="float:left; width:1px; margin-left:10px; z-index:2;">            <?php            $t = '<!-- Put this div tag to the place, where the Like block will be --><div id="vk_like" style="position:absolute;"></div><script type="text/javascript">VK.Widgets.Like("vk_like", {type: "vertical", height: 24});</script>';            echo $t;            ?>        </div>        <div style="clear:both"></div>    </div>    <div class="vender_box">        <div class="vender_box_top"></div>        <div class="vender_box_mid">            <div class="vender_adress">                <div class="vender_contact">Контактная информация:</div>                <strong><? echo stripslashes($row[2]);?></strong><br/>                <div style="float:left;"><strong>тел.: </strong></div>                <div style="float:left; margin-left:5px;"><? echo $row[3];?></div>                <div style="clear:left"></div>                <!-- Вывод URL сайта. Если есть тогда выводим. Нет, то значит и суда нет. -->                <?php function validString($str, $valids)            {                return strlen($str) == strspn($str, $valids);            }                if ($row[4] != NULL) {                    // URL может состоять из двух адресов, разделенных <br>                    $urlValid = explode('<br>', $row[4]);                    ?>                    <div style="float:left;"><strong>url : </strong></div>                    <div style="float:left; margin-left:11px;">                        <a class="vender_email" href="<?php echo $urlValid[0]; ?>"                           target="_blank"><?php echo $urlValid[0]; ?></a><br/>                        <a class="vender_email" href="<?php echo $urlValid[1]; ?>"                           target="_blank"><?php echo $urlValid[1]; ?></a><br/>                    </div>                    <?php                } ?>                <!-- /Вывод URL сайта -->                <div style="clear:left"></div>            </div>            <div class="vender_maps"><?php                if (strpos($row[2], '<br>')) $adresa = substr($row[2], 0, strpos($row[2], '<br>'));                else $adresa = $row[2];                if (!strpos($row[2], 'Херсон')) $adresa = 'г. Херсон,' . $adresa;                $geocode = file_get_contents('http://geocode-maps.yandex.ru/1.x/?geocode=' . urlencode($adresa) . '&key=AHw5xk8BAAAAfGesBQMAybpBVLZALLQrRgEBzbSomGc4QM8AAAAAAAAAAADfVm6NtO8kP3fPbig_F7rsomV_5Q==');                $xml = new SimpleXMLElement($geocode);                $xml->registerXPathNamespace('ymaps', 'http://maps.yandex.ru/ymaps/1.x');                $xml->registerXPathNamespace('gml', 'http://www.opengis.net/gml');                $result = $xml->xpath('/ymaps:ymaps/ymaps:GeoObjectCollection/gml:featureMember/ymaps:GeoObject/gml:Point/gml:pos');                $coord = str_replace(" ", ",", $result[0]);                $pt = '&pt=' . $coord . ',vkbkm';                ?>                <img src="http://static-maps.yandex.ru/1.x/?ll=<? echo $coord;?>&z=16&l=map&size=300,190<? echo $pt;?>&key=AHw5xk8BAAAAfGesBQMAybpBVLZALLQrRgEBzbSomGc4QM8AAAAAAAAAAADfVm6NtO8kP3fPbig_F7rsomV_5Q==">            </div>            <div style="clear:both"></div>        </div>        <div class="vender_box_bot"></div>    </div>    <script type="text/javascript">        $(document).ready(function () {            $(".fancybox-thumb").fancybox({                prevEffect:'none',                nextEffect:'none',                helpers:{                    title:{                        type:'outside'                    },                    thumbs:{                        width:50,                        height:50                    }                }            });        });    </script>    <!-- Вывод информации о вендере с базы данных, где есть уже все оформленные тэги -->    <div class="vender_description">        <?php// -- Путь до папки с картинками, причем номер папки == id вендера, который сейчас выбран --        $pathToImage = substr(DIR_LOGO_PARTNER,1) . "/$row[0]";        if (is_dir($pathToImage)) {// -- Сканирует папку на количество файлов.// -- array_diff выводит разницу между двумя массивами.// -- В данном случае он вернет именно тот массив имен, который нужен, без точек// -- т.к. scandir сканирует папку с точками. --            $items = array_diff(scandir($pathToImage), array('..', '.'));// -- Счетчик картинок --            $cnt = 0;// -- Перечисляем все файлы. --            foreach ($items as $key => $item) {// -- Первое, что нужно сделать, это соединить все пути, т.е. получается полный путь к картинке с именем и расширением --               $filePath = $pathToImage . '/' . $item;// -- Дальше, чтобы убрать расширение мы используем функцию pathinfo --                $filename = pathinfo($filePath, PATHINFO_FILENAME);// -- Теперь, нам нужно подсчитать количества файлов, которое будет равно последнему имени картинки.// -- При этом, мы должны убрать все маленькие картинки, чтобы можно было сосчитать --                if (strpos($filename, 'sm_') === 0) continue;// -- Счетчик, куда заносятся количества картинок без расширения и без маленький превьюшек --                $cnt++;            }            // -- И теперь, зная количество, мы можем спокойно выводить их на экран --            for ($i = 1; $i <= $cnt; $i++) {                ?>                <a class="fancybox-thumb" rel="fancybox-thumb" href="<?php echo '/'.$pathToImage.'/'.$i.'.jpg'; ?>"                   title='<?php echo htmlentities(stripslashes($row[1])); ?>'>                    <img src="<?php echo '/'.$pathToImage.'/sm_'.$i.'.jpg'; ?>" alt='<?php echo htmlentities(stripslashes($row[1])); ?>'></a>                <?php            }        } ?>        <!-- Сам вывод информации с тэгами -->        <? echo $row[5];?>    </div>    <!-- /Вывод информации о вендере -->    <script type="text/javascript" src="http://userapi.com/js/api/openapi.js?49"></script>    <script type="text/javascript">        VK.init({apiId:2983964, onlyWidgets:true});    </script>    <div id="vk_comments" style="margin:20px"></div>    <script type="text/javascript">        VK.Widgets.Comments("vk_comments", {limit:10, width:"699", attach:"*"});    </script>    <?    } else {        $_SESSION['changed'] = 1;        echo '<script language="javascript">	top.location.href="/page/' . CHANGED_PAGE . '";	</script>';    }} /// Если выбрана категория, вывод всех магазинов данной категорииelseif (isset($_GET['category']) && is_numeric($_GET['category'])) {    $sql = "SELECT id, category_name FROM categories WHERE id='" . $_GET['category'] . "'";    $res = mysql_query($sql, $db) or die('нет связи с БД');    $row = mysql_fetch_row($res);    ?><div class="vender_main"><a class="vender_main_a" href="<? echo $url_page; ?>">Все магазины</a> | <? echo stripslashes($row[1]);?></div><?    $sql = "SELECT * FROM vender WHERE FIND_IN_SET('".$row[0]."',category)>0 AND active='1' AND city='".$_SESSION['city']."'";    $res = mysql_query($sql, $db);    $num_of_row = mysql_num_rows($res);    if (!is_numeric($_GET['numberpage']) || 0 >= $_GET['numberpage'] || $_GET['numberpage'] > ceil($num_of_row / LIMIT_PAGE_VENDER)) $numberpage = 1;    else $numberpage = $_GET['numberpage'];    $sql1 = "SELECT id, name, discount, logo, adress, phones FROM vender WHERE FIND_IN_SET('".$row[0]."',category)>0 AND active='1' AND city='".$_SESSION['city']."' ORDER BY logo_pos ASC LIMIT " . ($numberpage - 1) * LIMIT_PAGE_VENDER . "," . LIMIT_PAGE_VENDER;    $res1 = mysql_query($sql1, $db) or die('нет связи с БД');    while ($row1 = mysql_fetch_row($res1)) {        ?><div style="margin-left:1px;"> <div class="vender_ladn">     <a style="float:left; display:block; text-decoration: none;"        href="<? echo $url_page; ?>/category/<? echo $row[0];?>/partner/<? echo $row1[0];?>">         <div class="vender_ladn_logo"><img src="<? echo DIR_LOGO_PARTNER . '/' . $row1[3]; ?>" width="350" height="60">         </div>         <div class="vender_ladn_adress">             <div class="vender_ladn_adress_header"><? echo stripslashes($row1[1]);?></div>             <?             $txtt = $row1[4];             if (strpos($txtt, '<br>')) $txtt = substr($row1[4], 0, strpos($txtt, '<br>'));             if (strpos($txtt, 'Херсон')) $txtt = substr($txtt, strpos($txtt, 'Херсон') + 12);             if ($txtt) echo stripslashes($txtt) . '<br>';             ?>             <? echo stripslashes($row1[5]);?>         </div>         <div class="vender_ladn_discount">             <div class="vender_ladn_discount_header">Скидка:</div>             <div class="vender_ladn_discount_yellow"><? echo $row1[2];?></div>             <div class="vender_ladn_discount_procent"></div>             <div style="clear:left"></div>         </div>     </a>     <div class="vender_ladn_notify"><?         if (isset($_SESSION['id_user']) && is_numeric($_SESSION['id_user']))             echo '<a href="' . $url_cat . '/notify/' . $row1[0] . '">	<img src="' . DIR_MAIN_IMAGES . '/notify_user.png" border="0"/>	</a>';         else echo '<img src="' . DIR_MAIN_IMAGES . '/notify.png" border="0"/>'; ?></div>     <div style="clear:left"></div>     </a> </div>        <?    }    echo_page_number($num_of_row, LIMIT_PAGE_VENDER, './' . $url_cat);} /// Если выбрана рубрика МАГАЗИН, вывод всех категорийelseif (isset($_GET['page']) && is_numeric($_GET['page'])) {    ?>    <div class="vender_main"><a class="vender_main_a" href="<? echo $url_page; ?>">Все магазины</a></div><?    $sql = "SELECT * FROM vender WHERE active='1' AND category NOT IN (18) AND city='".$_SESSION['city']."'";    $res = mysql_query($sql, $db);    $num_of_row = mysql_num_rows($res);    if (!is_numeric($_GET['numberpage']) || 0 >= $_GET['numberpage'] || $_GET['numberpage'] > ceil($num_of_row / LIMIT_PAGE_VENDER)) $numberpage = 1;    else $numberpage = $_GET['numberpage'];    $sql1 = "SELECT id, name, discount, logo, adress, phones, category FROM vender WHERE active='1' AND city='".$_SESSION['city']."' AND category NOT IN (18) ORDER BY logo_pos ASC LIMIT " . ($numberpage - 1) * LIMIT_PAGE_VENDER . "," . LIMIT_PAGE_VENDER;    $res1 = mysql_query($sql1, $db) or die('нет связи с БД');    while ($row1 = mysql_fetch_row($res1)) {        ?>        <div style="margin-left:1px;">            <div class="vender_ladn">                <a style="float:left; display:block; text-decoration: none;"                   href="<? echo $url_page; ?>/category/<? echo $row1[6];?>/partner/<? echo $row1[0];?>">                    <div class="vender_ladn_logo"><img src="<? echo DIR_LOGO_PARTNER . '/' . $row1[3]; ?>" width="350"                                                       height="60"></div>                    <div class="vender_ladn_adress">                        <div class="vender_ladn_adress_header"><? echo stripslashes($row1[1]);?></div>                        <?                        $txtt = $row1[4];                        if (strpos($txtt, '<br>')) $txtt = substr($row1[4], 0, strpos($txtt, '<br>'));                        if (strpos($txtt, 'Херсон')) $txtt = substr($txtt, strpos($txtt, 'Херсон') + 12);                        if ($txtt) echo $txtt . '<br>'; ?>                        <? echo stripslashes($row1[5]);?>                    </div>                    <div class="vender_ladn_discount">                        <div class="vender_ladn_discount_header">Скидка:</div>                        <div class="vender_ladn_discount_yellow"><? echo $row1[2];?></div>                        <div class="vender_ladn_discount_procent"></div>                        <div style="clear:left"></div>                    </div>                </a>                <div class="vender_ladn_notify"><?                    if (isset($_SESSION['id_user']) && is_numeric($_SESSION['id_user']))                        echo '<a href="' . $url_page . '/category/' . $row1[6] . '/notify/' . $row1[0] . '">	<img src="' . DIR_MAIN_IMAGES . '/notify_user.png" border="0"/>	</a>';                    else echo '<img src="' . DIR_MAIN_IMAGES . '/notify.png" border="0"/>'; ?>                </div>                <div style="clear:left"></div>            </div>        </div>    <?    }    echo_page_number($num_of_row, LIMIT_PAGE_VENDER, '/page/' . $_GET['page']);    /// тут сделать СТРАНИЦЫ}?>